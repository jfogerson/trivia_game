{% extends "base.html" %}

{% block content %}
<div class="intro">
    <h1>ðŸŽ® Welcome to the Trivia Challenge!</h1>
    <img src="{{ url_for('static', filename='battle.png') }}" alt="Battle" style="max-width: 300px; height: auto; margin: 10px 0;">
    <p>Get ready for an epic battle of wits!</p>
    <div style="margin: 20px 0;">
        <h2>Game Rules</h2>
        <ul style="text-align: left; display: inline-block;">
            <li>3 rounds with 15 questions each</li>
            <li>30 seconds per question</li>
            <li>Vote to eliminate incorrect players</li>
            <li>Round 1: 1 point, Round 2: 2 points, Round 3: 4 points</li>
            <li>10 points = elimination</li>
        </ul>
    </div>
</div>

<div id="waitingArea">
    <h2>Waiting for Game to Start...</h2>
    <div id="playerList" class="player-list"></div>
    <div id="status" style="text-align: center; margin: 20px 0; font-size: 18px;"></div>
</div>

<div id="gameArea" style="display: none;">
    <div id="gameContent"></div>
</div>

<script>
const socket = io();
const gameId = window.location.pathname.split('/')[2];

// Get player info from session via API
fetch('/api/get_session_info', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ game_id: gameId })
})
.then(response => response.json())
.then(sessionData => {
    if (!sessionData.success) {
        window.location.href = '/';
        return;
    }
    
    const playerName = sessionData.player_name;
    
    socket.emit('join_game', {
        game_id: gameId,
        player_name: playerName
    });
})
.catch(error => {
    console.error('Error:', error);
    window.location.href = '/';
});

socket.on('joined_game', function(data) {
    document.getElementById('status').textContent = `Welcome, ${data.player_name}! Waiting for other players...`;
});

socket.on('player_joined', function(data) {
    const playerList = document.getElementById('playerList');
    playerList.innerHTML = '';
    data.players.forEach(player => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player';
        if (player.eliminated) playerDiv.classList.add('eliminated');
        playerDiv.innerHTML = `
            <strong>${player.name}</strong><br>
            Score: ${player.score}
            ${player.eliminated ? '<br><em>Eliminated</em>' : ''}
            ${player.readonly ? '<br><em>Read-only</em>' : ''}
        `;
        playerList.appendChild(playerDiv);
    });
});

socket.on('game_started', function() {
    document.getElementById('waitingArea').style.display = 'none';
    document.getElementById('gameArea').style.display = 'block';
    window.location.href = `/game/${gameId}/play`;
});

socket.on('error', function(data) {
    alert(data.message);
    window.location.href = '/';
});

socket.on('game_cancelled', function(data) {
    alert(data.message);
    window.location.href = '/';
});

socket.on('game_stopped', function(data) {
    alert(data.message);
    location.reload();
});

socket.on('close_tab', function(data) {
    alert(data.message);
    window.close();
});
</script>
{% endblock %}