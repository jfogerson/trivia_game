{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/admin/dashboard" class="btn" style="background: #6c757d;">‚Üê Return to Dashboard</a>
</div>

<h1>Game Admin Panel - Game ID: {{ game_id }}</h1>

<div id="gameControls">
    <button id="startGameBtn" class="btn">Start Game</button>
    <button id="stopGameBtn" class="btn" style="background: #dc3545;">Stop Game</button>
    <button id="nextQuestionBtn" class="btn" style="background: #28a745; display: none;">Next Question</button>
</div>

<div id="gameStatus">
    <h2>Game Status: <span id="status">Waiting</span></h2>
    <p>Players: <span id="playerCount">0</span>/100</p>
</div>

<div id="playersArea">
    <h2>Players</h2>
    <div id="playersList" class="player-list"></div>
</div>

<div id="questionSummary" style="display: none; margin-top: 20px;">
    <h3>Question Results</h3>
    <div id="correctPlayersList"></div>
    <div id="incorrectPlayersList"></div>
    <div id="currentScores"></div>
    <div id="votingStatus"></div>
</div>

<script>
const socket = io();
const gameId = '{{ game_id }}';

console.log('Admin connecting to game:', gameId);

socket.emit('admin_join', { game_id: gameId });

document.getElementById('startGameBtn').onclick = function() {
    console.log('Starting game:', gameId);
    socket.emit('start_game', { game_id: gameId });
};

document.getElementById('stopGameBtn').onclick = function() {
    if (confirm('Are you sure you want to stop this game?')) {
        console.log('Stopping game:', gameId);
        socket.emit('stop_game', { game_id: gameId });
    }
};

document.getElementById('nextQuestionBtn').onclick = function() {
    console.log('Starting next question:', gameId);
    socket.emit('next_question', { game_id: gameId });
    document.getElementById('nextQuestionBtn').style.display = 'none';
    document.getElementById('questionSummary').style.display = 'none';
};

socket.on('admin_joined', function() {
    console.log('Admin successfully joined game');
});

socket.on('player_joined', function(data) {
    console.log('Player joined:', data);
    document.getElementById('playerCount').textContent = data.players.length;
    
    const playersList = document.getElementById('playersList');
    playersList.innerHTML = '';
    
    data.players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player';
        if (player.eliminated) div.classList.add('eliminated');
        
        div.innerHTML = `
            <strong>${player.name}</strong><br>
            Score: ${player.score}<br>
            ${player.eliminated ? '<em>Eliminated</em>' : ''}
            ${player.readonly ? '<em>Read-only</em>' : ''}
        `;
        playersList.appendChild(div);
    });
});

socket.on('admin_player_list', function(data) {
    console.log('Admin player list:', data);
    document.getElementById('playerCount').textContent = data.players.length;
    
    const playersList = document.getElementById('playersList');
    playersList.innerHTML = '';
    
    data.players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player';
        if (player.eliminated) div.classList.add('eliminated');
        
        div.innerHTML = `
            <strong>${player.name}</strong><br>
            Score: ${player.score}<br>
            ${player.eliminated ? '<em>Eliminated</em>' : ''}
            ${player.readonly ? '<em>Read-only</em>' : ''}
        `;
        playersList.appendChild(div);
    });
});

socket.on('game_started', function() {
    document.getElementById('status').textContent = 'Playing';
    document.getElementById('startGameBtn').disabled = true;
    document.getElementById('stopGameBtn').disabled = false;
});

socket.on('game_stopped', function(data) {
    document.getElementById('status').textContent = 'Waiting';
    document.getElementById('startGameBtn').disabled = false;
    document.getElementById('stopGameBtn').disabled = true;
    document.getElementById('nextQuestionBtn').style.display = 'none';
    alert(data.message);
});



socket.on('voting_update', function(data) {
    document.getElementById('votingStatus').innerHTML = 
        `<p>Votes cast: ${data.votes_cast}/${data.total_voters}</p>
         <p>Waiting for ${data.total_voters - data.votes_cast} more votes...</p>`;
});

socket.on('admin_question_summary', function(data) {
    console.log('Final question summary:', data);
    
    document.getElementById('correctPlayersList').innerHTML = 
        '<h4>Correct Players:</h4>' + 
        data.correct_players.map(p => p.name).join(', ');
    
    document.getElementById('incorrectPlayersList').innerHTML = 
        '<h4>Incorrect Players:</h4>' + 
        data.incorrect_players.map(p => p.name).join(', ');
    
    // Show points awarded this round
    let pointsHtml = '<h4>Points Awarded This Round:</h4>';
    Object.entries(data.points_awarded || {}).forEach(([sid, points]) => {
        const playerName = Object.values(data.all_scores).find((name, idx) => 
            Object.keys(data.all_scores)[idx] === name);
        pointsHtml += `<p>Player: ${points} points</p>`;
    });
    
    let scoresHtml = '<h4>Current Total Scores:</h4>';
    Object.entries(data.all_scores).forEach(([name, score]) => {
        scoresHtml += `<p>${name}: ${score} points</p>`;
    });
    
    document.getElementById('votingStatus').innerHTML = pointsHtml;
    document.getElementById('currentScores').innerHTML = scoresHtml;
    
    document.getElementById('questionSummary').style.display = 'block';
    document.getElementById('nextQuestionBtn').style.display = 'inline-block';
});

socket.on('connect', function() {
    console.log('Socket connected');
});

socket.on('disconnect', function() {
    console.log('Socket disconnected');
});

socket.on('error', function(data) {
    console.error('Socket error:', data);
    alert('Error: ' + data.message);
});

socket.on('player_eliminated', function(data) {
    alert(`${data.name} has been eliminated!`);
    // Request updated player list
    socket.emit('get_players', { game_id: gameId });
});
</script>
{% endblock %}