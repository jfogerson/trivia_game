{% extends "base.html" %}

{% block content %}
<div id="gameHeader">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div id="roundInfo"></div>
        <div id="timer" class="timer">15</div>
        <div id="playerInfo"></div>
    </div>
</div>

<div id="questionArea" class="question-box" style="display: none;">
    <h2 id="questionText"></h2>
    <div id="optionsArea" class="options"></div>
    <div id="submitArea" style="text-align: center; margin: 20px 0;">
        <button id="submitBtn" class="btn" disabled>Submit Answer</button>
    </div>
</div>

<div id="resultArea" style="display: none;">
    <h3>Question Result</h3>
    <div id="correctAnswer"></div>
    <div id="playerResults"></div>
</div>

<div id="votingArea" style="display: none;">
    <h3>Vote to Eliminate</h3>
    <p>Select a player who answered incorrectly:</p>
    <div id="votingOptions"></div>
</div>

<div id="scoresArea" class="scores">
    <h3>Current Scores</h3>
    <div id="scoresList"></div>
</div>

<div id="finalResults" style="display: none;">
    <h2>Game Over!</h2>
    <div id="finalScores"></div>
</div>

<script>
const socket = io();
const gameId = window.location.pathname.split('/')[2];
const urlParams = new URLSearchParams(window.location.search);
const playerName = urlParams.get('name');
const gamePassword = urlParams.get('password') || sessionStorage.getItem('gamePassword');

let currentQuestion = null;
let selectedAnswer = null;
let timeLeft = 15;
let timerInterval = null;

console.log('Connecting to game:', gameId, 'as player:', playerName);

socket.emit('join_game', {
    game_id: gameId,
    password: gamePassword,
    player_name: playerName
});

socket.on('joined_game', function(data) {
    console.log('Successfully joined game:', data);
});

socket.on('error', function(data) {
    console.error('Game error:', data);
    alert('Error: ' + data.message);
});

socket.on('connect', function() {
    console.log('Socket connected');
});

socket.on('disconnect', function() {
    console.log('Socket disconnected');
});

socket.on('new_question', function(data) {
    console.log('Received new question:', data);
    console.log('Current game state - Round:', data.round, 'Question:', data.question_num);
    
    currentQuestion = data;
    selectedAnswer = null;
    timeLeft = 15;
    
    // Clear any existing timer
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    document.getElementById('roundInfo').textContent = `Round ${data.round} - Question ${data.question_num}/15`;
    document.getElementById('questionText').textContent = data.question;
    
    const optionsArea = document.getElementById('optionsArea');
    optionsArea.innerHTML = '';
    
    Object.entries(data.options).forEach(([key, value]) => {
        const option = document.createElement('div');
        option.className = 'option';
        option.textContent = `${key.toUpperCase()}) ${value}`;
        option.onclick = () => selectOption(key, option);
        optionsArea.appendChild(option);
    });
    
    // Reset UI state
    document.getElementById('questionArea').style.display = 'block';
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('votingArea').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
    
    // Reset option styles
    document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected', 'correct', 'incorrect');
        opt.style.pointerEvents = 'auto';
    });
    
    console.log('Question UI updated, starting timer');
    startTimer();
});

function selectOption(answer, element) {
    document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
    element.classList.add('selected');
    selectedAnswer = answer;
    document.getElementById('submitBtn').disabled = false;
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        document.getElementById('timer').textContent = timeLeft;
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(timerInterval);
            if (selectedAnswer) {
                submitAnswer();
            }
        }
    }, 1000);
}

document.getElementById('submitBtn').onclick = submitAnswer;

function submitAnswer() {
    if (!selectedAnswer) return;
    
    socket.emit('submit_answer', {
        game_id: gameId,
        answer: selectedAnswer
    });
    
    document.getElementById('submitBtn').disabled = true;
    document.querySelectorAll('.option').forEach(opt => opt.style.pointerEvents = 'none');
}

socket.on('question_result', function(data) {
    clearInterval(timerInterval);
    
    document.getElementById('correctAnswer').innerHTML = `<strong>Correct Answer: ${data.correct_answer.toUpperCase()}</strong>`;
    
    const correct = data.correct_players.map(p => p.name).join(', ');
    const incorrect = data.incorrect_players.map(p => p.name).join(', ');
    
    document.getElementById('playerResults').innerHTML = `
        <p><strong>Correct:</strong> ${correct || 'None'}</p>
        <p><strong>Incorrect:</strong> ${incorrect || 'None'}</p>
    `;
    
    // Highlight correct answer
    document.querySelectorAll('.option').forEach(opt => {
        const optionLetter = opt.textContent.charAt(0).toLowerCase();
        if (optionLetter === data.correct_answer) {
            opt.classList.add('correct');
        } else if (selectedAnswer === optionLetter) {
            opt.classList.add('incorrect');
        }
    });
    
    document.getElementById('resultArea').style.display = 'block';
});

socket.on('voting_phase', function(data) {
    console.log('Voting phase started:', data);
    const votingOptions = document.getElementById('votingOptions');
    votingOptions.innerHTML = '';
    
    // Add voting timer
    let votingTimeLeft = data.time_limit || 30;
    const timerDiv = document.createElement('div');
    timerDiv.id = 'votingTimer';
    timerDiv.style.fontSize = '18px';
    timerDiv.style.fontWeight = 'bold';
    timerDiv.style.textAlign = 'center';
    timerDiv.style.margin = '10px 0';
    votingOptions.appendChild(timerDiv);
    
    const votingInterval = setInterval(() => {
        timerDiv.textContent = `Time to vote: ${votingTimeLeft}s`;
        votingTimeLeft--;
        
        if (votingTimeLeft < 0) {
            clearInterval(votingInterval);
            timerDiv.textContent = 'Voting ended - random selection if no vote cast';
        }
    }, 1000);
    
    if (data.incorrect_players.length === 0) {
        votingOptions.innerHTML += '<p>No players available to vote for.</p>';
    } else {
        data.incorrect_players.forEach(player => {
            const button = document.createElement('button');
            button.className = 'btn';
            button.textContent = player.name;
            button.onclick = () => {
                votePlayer(player.sid);
                clearInterval(votingInterval);
            };
            votingOptions.appendChild(button);
        });
    }
    
    document.getElementById('votingArea').style.display = 'block';
});

function votePlayer(targetSid) {
    socket.emit('vote_player', {
        game_id: gameId,
        target_sid: targetSid
    });
    
    document.getElementById('votingArea').style.display = 'none';
}

socket.on('vote_recorded', function(data) {
    if (data.auto_selected) {
        alert(`Time expired! Automatically voted for ${data.target} (+${data.points} point)`);
    } else {
        alert(`You voted for ${data.target} (+${data.points} point)`);
    }
    document.getElementById('votingArea').style.display = 'none';
});

socket.on('vote_failed', function(data) {
    alert(data.message);
    
    // Update voting options with available targets
    const votingOptions = document.getElementById('votingOptions');
    votingOptions.innerHTML = '';
    
    if (data.available_targets.length === 0) {
        votingOptions.innerHTML = '<p>No more players available to vote for.</p>';
    } else {
        data.available_targets.forEach(player => {
            const button = document.createElement('button');
            button.className = 'btn';
            button.textContent = player.name;
            button.onclick = () => votePlayer(player.sid);
            votingOptions.appendChild(button);
        });
    }
});

socket.on('points_received', function(data) {
    alert(data.message);
});

socket.on('player_eliminated', function(data) {
    alert(`${data.name} has been eliminated from the game!`);
    
    // Update scores display to show elimination
    const scoresList = document.getElementById('scoresList');
    const playerDivs = scoresList.children;
    for (let div of playerDivs) {
        if (div.innerHTML.includes(data.name)) {
            div.style.color = '#999';
            div.style.textDecoration = 'line-through';
            break;
        }
    }
});

socket.on('round_ended', function(data) {
    alert(`Round ${data.next_round - 1} ended! Starting Round ${data.next_round}...`);
});

socket.on('game_ended', function(data) {
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('votingArea').style.display = 'none';
    
    const finalScores = document.getElementById('finalScores');
    finalScores.innerHTML = `<h3>üèÜ Winner: ${data.winner}!</h3><h3>Final Rankings:</h3>`;
    
    data.final_scores.forEach((score, index) => {
        const div = document.createElement('div');
        div.innerHTML = `${index + 1}. ${score[0]} - ${score[1]} points`;
        finalScores.appendChild(div);
    });
    
    document.getElementById('finalResults').style.display = 'block';
});

socket.on('player_joined', function(data) {
    const scoresList = document.getElementById('scoresList');
    scoresList.innerHTML = '';
    
    data.players.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `${player.name}: ${player.score} points ${player.eliminated ? '(Eliminated)' : ''}`;
        if (player.eliminated) {
            div.style.color = '#999';
            div.style.textDecoration = 'line-through';
        }
        scoresList.appendChild(div);
    });
});

socket.on('game_cancelled', function(data) {
    alert(data.message);
    window.location.href = '/';
});

socket.on('game_stopped', function(data) {
    alert(data.message);
    location.reload();
});

socket.on('close_tab', function(data) {
    alert(data.message);
    window.close();
});

socket.on('timer_stop', function() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        document.getElementById('timer').textContent = 'All answered!';
    }
});
</script>
{% endblock %}